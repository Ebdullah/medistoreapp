<div class="d-flex flex-column flex-shrink-0 p-3 bg-white shadow-sm " id="sidebarAccordion" style="width: 250px; position: fixed; height: 100vh; border-right: 2px solid #D3D3D3;overflow-y: auto;">
  <div class="text-center mb-3">
    <%= image_tag 'logo.png', alt: 'Logo', class: 'd-inline-block align-text-top img-fluid', style: 'max-height: 100px;' %>
  </div>

  <ul class="nav nav-pills flex-column mb-auto mt-4">
    <% if user_signed_in? %>
      <% if current_user.super_admin? || current_user.branch_admin? %>
        <li class="nav-item">
          <%= link_to 'Dashboard', dashboard_path, class: "nav-link text-dark #{'active' if current_page?(dashboard_path)}", style: 'padding: 10px;'  %>
        </li>
      <% end %>

        <!-- Profile Link -->
      <% if current_user.customer? %>
      <li class="nav-item">
        <%= link_to 'Home', portal_users_path, class: "nav-link text-dark #{'active' if current_page?(portal_users_path)}", style: 'padding: 10px;' %>
      </li>
      <% end %>
      <% if current_user.customer? %>
      <li class="nav-item">
        <%= link_to 'Profile', user_profile_path(current_user.id), class: "nav-link text-dark #{'active' if current_page?(user_profile_path(current_user.id))}", style: 'padding: 10px;' %>
      </li>
      <% end %>
      <% if policy(Record).select_branch_for_purchase? %>
        <li class="nav-item">
           <%= link_to 'Buy Medicines', select_branch_for_purchase_path, class: "nav-link text-dark #{'active' if current_page?(select_branch_for_purchase_path)}", style: 'padding: 10px;' %>
        </li>
      <% end %>

        <!-- Edit Profile Link -->
      <% if current_user.customer? %>
      <li><%= link_to 'My Purchases', my_purchases_path,  class: "nav-link text-dark #{'active' if current_page?(my_purchases_path)}", style: 'padding: 10px;' %></li>
      <li class="nav-item">
        <%= link_to 'Edit Profile', edit_user_registration_path, class: "nav-link text-dark #{'active' if current_page?(edit_user_registration_path)}", style: 'padding: 10px;' %>
      </li>
      <% end %>

      <% if policy(Notification).index? %>
        <li class="nav-item">
          <%= link_to 'Notifications', notifications_path, class: "nav-link text-dark #{'active' if current_page?(notifications_path)}", style: 'padding: 10px;' %>
        </li>
      <% end %>

      <% if policy(Branch).index? %>
        <li class="nav-item">
          <!-- Determine if the branches section should be expanded based on the current page -->
          <% expanded_branches = BranchPolicy::Scope.new(current_user, Branch).resolve.any? do |branch| 
            current_page?(branch_records_path(branch)) ||
            current_page?(branch_medicines_path(branch)) ||
            current_page?(expired_branch_medicines_path(branch)) ||
            current_page?(branch_stock_transfers_path(branch)) ||
            current_page?(branch_audit_logs_path(branch))
          end %>

          <a class="nav-link text-dark" href="#branchesCollapse" id="branchesToggle" role="button" data-bs-toggle="dropdown" data-bs-target="#branchesCollapse" aria-expanded="<%= expanded_branches ? 'true' : 'false' %>" style="padding: 10px;" onclick="toggleDropdown(event)">
            Manage Branches
          </a>

          <!-- Keep the 'collapse' class and add 'show' if expanded -->
          <div class="collapse <%= 'show' if expanded_branches %>" id="branchesCollapse" data-bs-parent="#sidebarAccordion">
            <ul class="list-unstyled ps-3">
              <% if current_user.super_admin? %>
                <li>
                  <%= link_to 'ALL Branches', branches_path, class: "nav-link rounded py-2 #{'active' if current_page?(branches_path)}" %>
                </li>
              <% end %>
              <% BranchPolicy::Scope.new(current_user, Branch).resolve.each do |branch| %>
                <li class="mt-1">
                  <!-- Determine if this branch's dropdown should be expanded -->
                  <% branch_expanded = current_page?(branch_records_path(branch)) ||
                                      current_page?(branch_medicines_path(branch)) ||
                                      current_page?(expired_branch_medicines_path(branch)) ||
                                      current_page?(branch_stock_transfers_path(branch)) ||
                                      current_page?(branch_audit_logs_path(branch)) %>

                  <a class="nav-link dropdown-toggle text-dark" href="#" id="branch-<%= branch.id %>" role="button" data-bs-toggle="collapse" data-bs-target="#branchCollapse-<%= branch.id %>" aria-expanded="<%= branch_expanded ? 'true' : 'false' %>" style="padding: 10px;">
                    <%= branch.name %>
                  </a>

                  <!-- Keep the 'collapse' class and add 'show' if branch is expanded -->
                  <div class="collapse <%= 'show' if branch_expanded %>" id="branchCollapse-<%= branch.id %>" data-bs-parent="#branchesCollapse">
                    <ul class="list-unstyled ps-3">
                      <li><%= link_to 'Records', branch_records_path(branch), class: "nav-link text-dark #{'active' if current_page?(branch_records_path(branch))}" if policy(Record).index? %></li>
                      <li><%= link_to 'Medicines', branch_medicines_path(branch), class: "nav-link text-dark #{'active' if current_page?(branch_medicines_path(branch))}" if policy(Medicine).index? %></li>
                      <li><%= link_to 'Expired Medicines', expired_branch_medicines_path(branch), class: "nav-link text-dark #{'active' if current_page?(expired_branch_medicines_path(branch))}" if policy(Medicine).expired? %></li>
                      <li><%= link_to 'Stock Transfers', branch_stock_transfers_path(branch), class: "nav-link text-dark #{'active' if current_page?(branch_stock_transfers_path(branch))}" if policy(StockTransfer).index? %></li>
                      <li><%= link_to 'Audit Logs', branch_audit_logs_path(branch), class: "nav-link text-dark #{'active' if current_page?(branch_audit_logs_path(branch))}" if policy(AuditLog).index? %></li>
                      <li><%= link_to 'Archived Records', branch_archives_path(branch), class: "nav-link text-dark #{'active' if current_page?(branch_archives_path(branch))}" if current_user.super_admin? %></li>
                      <li><%= link_to 'Refunds', branch_refunds_path(@branch), class: "nav-link text-dark #{'active' if current_page?(branch_refunds_path(@branch))}" if current_user.branch_admin? %></li>
                    </ul>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        </li>
      <% end %>

      <% if current_user.super_admin? %>
        <li class="nav-item">
          <%= link_to 'Users', users_path, class: "nav-link text-dark #{'active' if current_page?(users_path)}", style: 'padding: 10px;' %>
        </li>
      <% end %>
    <% end %>
  </ul>

  <div class="mt-auto mb-4">
    <% if user_signed_in? %>
      <%= button_to destroy_user_session_path, method: :delete, class: 'btn btn-dark w-100 d-flex justify-content-center align-items-center gap-2' do %>
        <span>Log Out</span>
        <i class="fas fa-sign-out-alt"></i>
      <% end %>
    <% end %>
  </div>
</div>

<style>
  #sidebarAccordion {
    background-color: white; 
    border-right: 2px solid #D3D3D3; 
  }
  #sidebarAccordion::-webkit-scrollbar {
      width: 0; 
      background: transparent; 
  }

  #sidebarAccordion {
      scrollbar-width: none; 
  }

  #sidebarAccordion {
      -ms-overflow-style: none;
  }

  .nav-link {
    color: #343a40 !important;
    padding: 10px; 
    transition: background-color 0.3s, border-left 0.3s; 
  }

  .nav-link.active {
    font-weight: bold;
    border-left: 4px solid black; 
    color: #343a40 !important; 
    background-color: transparent !important;
  }

  .nav-link.active:hover {
    color: #343a40 !important; 
    background-color: transparent !important; 
  }

  .nav-link:hover {
    color: #f8f9fa !important; 
    background-color: #343a40; 
  }

  .nav-item {
    margin-bottom: 0.5rem;
  }
</style>

<script>
  function toggleDropdown(event) {
    const target = document.getElementById('branchesCollapse');
    const isExpanded = target.classList.contains('show');

    // Close all other dropdowns
    const allDropdowns = document.querySelectorAll('.collapse');
    allDropdowns.forEach(dropdown => {
      if (dropdown !== target) {
        dropdown.classList.remove('show');
      }
    });

    // Toggle the current dropdown
    if (isExpanded) {
      target.classList.remove('show');
    } else {
      target.classList.add('show');
    }
  }
</script>
