<%= form_with(model: [@branch, @record], url: create_purchase_branch_records_path(@branch), method: :post, local: true, class: 'p-4', html: {id: "payment-form"}) do |form| %>
<div id="stripe-public-key" data-key="<%= Rails.application.credentials.stripe[:publishable_key] %>"></div>

  <div class="mb-4 p-3 border rounded bg-light">
    <h5 class="mb-3">Billing Details</h5>
    
    <div class="row mb-3">
      <div class="col-md-6">
        <%= form.label :customer_name, class: 'form-label' %>
        <%= form.text_field :customer_name, value: current_user.name, class: 'form-control', readonly: true %>
      </div>
      <div class="col-md-6">
        <%= form.label :customer_phone, class: 'form-label' %> <br>
        <%= form.hidden_field :country_code, id: 'country_code' %>
        <%= form.telephone_field :customer_phone, id: 'phone', value: current_user.phone, class: 'form-control' %>
      </div>
    </div>
    
    <div class="col-md-12">
      <%= form.label :payment_method, class: 'form-label' %>
      <%= form.select :payment_method, Record.payment_methods.keys.map { |w| [w.titleize, w] }, { prompt: "Payment Method" }, class: 'form-select', id: 'payment-method-select' %>
    </div>
    
    <!-- Payment Information -->
    <div id="additional-payment-info" class="mb-4 p-3 border rounded bg-light" style="display: none;">
      <h5 class="mb-3">Payment Information</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <%= form.label :house_no, class: 'form-label' %>
          <%= form.number_field :house_no, class: 'form-control' %>
        </div>
        <div class="col-md-6">
          <%= form.label :postal_code, class: 'form-label' %>
          <%= form.number_field :postal_code, class: 'form-control' %>
        </div>
      </div>
      <div class="row mb-3">
        <div class="col-md-12">
          <%= form.label :address, class: 'form-label' %>
          <%= form.text_field :address, class: 'form-control' %>
        </div>
      </div>

      <!-- Stripe Fields -->
      <div id="stripe-fields" style="display: none;">
        <h5 class="mb-3">Card Payment Information</h5>
        <div class="row mb-3">
          <div class="col-md-12">
            <%= form.label :stripe_email, "Stripe Email", class: 'form-label' %>
            <%= form.text_field :stripe_email, class: 'form-control', placeholder: 'Enter your Stripe email' %>
            <div id="card-element" class="form-control mt-2"></div>
            <input type="hidden" name="record[stripe_token]" value="">
            <div id="card-errors" role="alert"></div>
          </div>
        </div>
      </div>
    </div>

<div class="p-3 border rounded bg-light">
  <h5 class="mb-3">Medicine Details</h5>
  <div id="medicines-fields">
    <%= form.fields_for :record_items do |item_form| %>
      <div class="medicine-fields row mb-3">
        <div class="col-md-6">
          <%= item_form.label :medicine_id, class: 'form-label' %>
          <%= item_form.select :medicine_id, @medicines.map { |medicine| [medicine.name, medicine.id, { 'data-price': medicine.price, 'data-quantity': medicine.stock_quantity }] }, { prompt: "Search Medicine" }, class: 'form-select select2-medicine' %>
          <div class="available-quantity mt-1" style="font-weight: bold;">Available: <span class="quantity-value">0</span></div>
        </div>
        <div class="col-md-3">
          <%= item_form.label :quantity, class: 'form-label' %>
          <%= item_form.number_field :quantity, class: 'form-control quantity-field', min: 0 %>
        </div>
        <div class="col-md-3">
          <%= item_form.label :price, class: 'form-label' %>
          <%= item_form.number_field :price, class: 'form-control price-field', readonly: true %>
        </div>
        <div class="col-md-12 mt-2">
          <button type="button" class="btn btn-outline-dark remove-medicine">Remove</button>
        </div>
      </div>
    <% end %>
  </div>
</div>


  <div class="form-group">
    <button type="button" class="btn btn-dark" id="add-medicine">Add Medicine</button>
  </div>

  <div class="form-group mt-4">
    <div class="total-amount mt-3" style="font-weight: bold;">
      Total Amount: <span id="total-amount">0</span>
    </div>
    <%= form.submit 'Create Bill', id: "submitBtn", class: 'btn btn-dark w-100' %>
  </div>
</div>
<% end %>

<div id="medicines-data" data-medicines='<%= raw @branch.medicines.to_json(only: [:id, :name, :price, :stock_quantity]) %>'></div>

<script type="text/javascript">
  const medicinesData = <%= raw @medicines.to_json(only: [:id, :name, :price, :stock_quantity]) %>;


  document.addEventListener('DOMContentLoaded', () => {
    const initialMedicineSelect = $('.select2-medicine');

    initialMedicineSelect.select2({
      data: medicinesData.map(medicine => ({ id: medicine.id, text: medicine.name })),
      placeholder: 'Select Medicine',
      allowClear: true
    });

    
    initialMedicineSelect.on('select2:select', function (e) {
      const selectedOption = e.params.data;
      const selectedMedicine = medicinesData.find(medicine => medicine.id == selectedOption.id);
      const price = medicinesData.find(medicine => medicine.id == selectedOption.id).price;

      const quantityValue = $(this).closest('.medicine-fields').find('.quantity-value');
      const priceField = $(this).closest('.medicine-fields').find('.price-field');

      quantityValue.text(selectedMedicine.stock_quantity);
      priceField.val(price);
    });
  });
</script>


<%= javascript_pack_tag 'purchase' %>
<%= javascript_pack_tag 'stripe_payment' %>
<%= javascript_pack_tag 'intl-tel-input' %>

<script src="https://js.stripe.com/v3/"></script>